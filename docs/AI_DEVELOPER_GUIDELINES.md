# Gemini 開發指南 (AI_DEVELOPER_GUIDELINES.md)

## 1. 總體原則

本文件旨在指導 Gemini 在 Bitfinex Lending Bot 專案中的開發行為。請嚴格遵守以下核心原則：

*   **專案慣例優先：** 始終優先遵循專案中現有的程式碼風格、命名約定、模組結構和錯誤處理模式。在進行任何修改前，請仔細分析周圍的程式碼。
*   **模組化與可測試性：** 鼓勵將複雜功能拆分為獨立、可測試的單元。在 `src/test/unit/main_functions/` 中已建立的測試模式應作為新測試的參考。
*   **安全與驗證：** 任何修改都必須經過驗證。這包括運行相關的單元測試、執行專案的 Linting 和型別檢查（如果已配置），並在執行任何可能修改系統或程式碼的 shell 命令前，清晰地解釋其目的和潛在影響。
*   **用戶確認：** 在執行任何重大操作（特別是涉及真實 API 交易或文件系統修改）之前，務必向用戶確認。
*   **精簡與直接：** 溝通應簡潔、直接，避免冗餘的寒暄。輸出應盡量精簡，聚焦於核心資訊。

## 2. 強制與禁止事項

### 2.1 絕對禁止事項 (ABSOLUTE PROHIBITIONS)

*   **絕不** 修改 .env 等檔案。
*   **絕不** 在根目錄下創建新文件 → 請使用適當的模組結構。
*   **絕不** 將輸出文件直接寫入根目錄 → 請使用指定的輸出文件夾。
*   **絕不** 創建文檔文件 (.md)，除非用戶明確要求。
*   **絕不** 使用帶有 `-i` 標誌的 git 命令（不支援互動模式）。
*   **絕不** 使用 `find`、`grep`、`cat`、`head`、`tail`、`ls` 命令 → 請改用 Read、LS、Grep、Glob 工具。
*   **絕不** 創建重複文件（例如 `manager_v2.py`, `enhanced_xyz.py`, `utils_new.js`） → 始終擴展現有文件。
*   **絕不** 為同一概念創建多個實現 → 遵循單一事實來源原則。
*   **絕不** 複製貼上程式碼塊 → 請提取為共享工具/函數。
*   **絕不** 硬編碼應可配置的值 → 請使用配置文件/環境變數。
*   **絕不** 使用 `enhanced_`, `improved_`, `new_`, `v2_` 等命名 → 請擴展原始文件。

### 2.2 強制要求 (MANDATORY REQUIREMENTS)

*   **對所有長時間運行操作 (>30 秒) 使用任務代理 (TASK AGENTS)** - Bash 命令在上下文切換時會停止。
*   **對於複雜任務 (3 步以上) 使用 TodoWrite** → 並行代理 → git 檢查點 → 測試驗證。
*   **編輯前務必先讀取文件 (READ FILES FIRST)** - 如果您沒有先讀取文件，Edit/Write 工具將會失敗。
*   **技術債預防 (DEBT PREVENTION)** - 在創建新文件之前，檢查是否存在類似功能以進行擴展。
*   **單一事實來源 (SINGLE SOURCE OF TRUTH)** - 每個功能/概念只有一個權威實現。

## 3. 開發工作流程

當處理用戶請求時，請遵循以下步驟：

### 3.1 理解 (Understand)

*   **全面分析：** 使用 `read_file`、`read_many_files`、`glob` 和 `search_file_content` 工具，深入理解用戶請求的上下文、相關文件、現有程式碼模式和專案結構。
*   **識別依賴：** 檢查 `requirements.txt` 以確認現有函式庫的使用情況。除非專案中已有明確使用，否則不要假設任何函式庫可用。

### 3.2 規劃 (Plan)

*   **制定清晰計畫：** 根據理解階段的分析，制定一個具體、可行的實施計畫。計畫應考慮到對現有程式碼的影響，並盡量減少不必要的變動。
*   **測試先行：** 如果適用，考慮為新功能或修改的邏輯編寫單元測試，以建立安全網。

### 3.3 實施 (Implement)

*   **使用工具：** 優先使用 `replace`、`write_file` 和 `run_shell_command` 等工具來執行程式碼修改和文件操作。
*   **程式碼風格：** 嚴格遵循現有的 Python 程式碼風格（例如，變數命名、函數簽名、縮排）。
*   **註釋：** 僅在必要時添加高價值的註釋，解釋「為什麼」這樣做，而不是「做了什麼」。不要在程式碼塊中添加與用戶溝通的註釋。
*   **錯誤處理：** 模仿專案中現有的 `try-except` 模式。

### 3.4 驗證 (Verify)

*   **運行單元測試：** 在修改程式碼後，運行 `src/test/unit/main_functions/` 目錄下所有相關的單元測試，確保修改沒有引入迴歸。
*   **執行程式碼品質檢查：**
    *   **Linting:** 運行 `ruff check .` (如果已安裝並配置) 以檢查程式碼風格和潛在錯誤。
    *   **型別檢查:** 運行 `mypy .` (如果已安裝並配置) 以檢查型別一致性。
    *   如果這些工具未配置或不確定命令，請向用戶詢問。
*   **解釋 Shell 命令：** 在執行任何可能修改文件系統或程式碼的 `run_shell_command` 之前，務必簡要解釋命令的目的和潛在影響。

## 4. 工具使用規範

*   **絕對路徑：** 在使用 `read_file`、`write_file`、`replace` 等工具時，始終使用文件的絕對路徑。
*   **並行執行：** 在可能的情況下，並行執行多個獨立的工具呼叫。
*   **避免互動式命令：** 盡量避免需要用戶互動的 shell 命令。如果無法避免，請提醒用戶。
*   **真實 API 操作：** 當執行 `place_lending_offer`、`cancel_funding_offer` 等會觸發真實交易的測試或操作時，務必明確警告用戶。

## 5. Git 工作流程

當被要求提交更改或準備提交時，請遵循以下步驟：

*   **檢查狀態：** 始終先運行 `git status`、`git diff HEAD` 和 `git log -n 3` 以了解當前倉庫狀態、所有更改和最近的提交訊息風格。
*   **提出提交訊息：** 始終提出一個清晰、簡潔且聚焦於「為什麼」的提交訊息草稿，而不是簡單地要求用戶提供。
*   **確認成功：** 每次提交後，運行 `git status` 確認提交成功。
*   **不自行解決提交失敗：** 如果提交失敗，未經用戶明確指示，不要嘗試自行解決問題。
*   **不推送：** 未經用戶明確要求，絕不將更改推送到遠端倉庫。

## 6. 溝通規範

*   **簡潔明瞭：** 溝通應簡潔、直接，避免冗餘的寒暄。
*   **最小化輸出：** 每次回應的文字輸出應盡量少於 3 行（不包括工具使用/程式碼生成）。
*   **澄清歧義：** 如果請求模糊不清，請提出簡潔、有針對性的澄清問題。
*   **處理無法完成的請求：** 如果無法或不願完成某個請求，請簡要說明（1-2 句話），並在適當情況下提供替代方案。

---